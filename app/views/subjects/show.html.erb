<% title "#{@subject.cite}" %>

<% content_for(:buttons) do %>
  <%= link_to sti_subject_path(@subject.type, @subject, :edit), class: 'btn btn-default' do %>
    <%= fa_icon("edit") %>
    <%= "Edit" %>
  <% end %>
  <%= link_to @subject, method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-default' do %>
    <%= fa_icon("remove") %>
    <%= "Delete" %>
  <% end %>
<% end if current_user %>
<div class="row">
  <div class="col-md-12">

    <ol class="breadcrumb">
      <%= content_tag :li, link_to('All', sti_subject_path) %>
      <%= content_tag :li, link_to(@subject.root.type.pluralize, subjects_path(q: "type='#{@subject.root.type}'")) %>
      <%= content_tag :li, link_to((@subject.serie.abbr.present? ? @subject.serie.try(:abbr) : "[#{@subject.serie.name}]"), subjects_path(q: "serie:#{@subject.serie.try(:name)}#{' OR '+@subject.serie.try(:abbr) if @subject.serie.abbr.present?}")) if @subject.serie %>  
      <% @subject.ancestors.reverse.each do |e| %>
        <%= content_tag :li, link_to(e.cite, e) %>
      <% end %>
      <%= content_tag :li, @subject.cite, class: 'active' %>
    </ol>
    <%= content_tag :p, link_to(fa_icon('link', text: subject_url(@subject)), @subject) %>    
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <%= content_tag :h3, @subject.full_entry %>
    <%= content_tag :p, truncate(@subject.g_description, length: 240, separator: ' ') %>
    <table class="table table-striped">
      <tbody>
        <%= content_tag :tr do %>
          <th><%= @subject.creator_type %>:</th>
          <td><%= @subject.creators.map{|c| link_to c.name, subjects_path(q: "creator:#{c.lname}")}.join(', ').html_safe %></td>
        <% end if @subject.creators.any? %>

        <%= content_tag :tr do %>
          <th>Title:</th>
          <td><%= @subject.title %></td>
        <% end if @subject.title.present? %>
        <%= content_tag :tr do %>
          <th>Subtitle:</th>
          <td><%= @subject.subtitle %></td>
        <% end if @subject.subtitle.present? %>
        <%= content_tag :tr do %>
          <th>In:</th>
          <td><%= link_to @subject.parent.full_entry, @subject.parent %></td>
        <% end if @subject.child? %>
        <%= content_tag :tr do %>
          <th>Serial or Journal:</th>
          <td>
            <%= link_to subjects_path(q: "serie:#{@subject.serie.try(:name)}#{' OR '+@subject.serie.try(:abbr) if @subject.serie.abbr.present?}") do %>
              <%= @subject.serie.try(:name) %>
              <%= "(#{@subject.serie.abbr})" if @subject.serie.abbr.present? %>
            <% end %>
            <%= @subject.volume %>
          </td>
        <% end if @subject.root? && @subject.serie %>
        
        <%= content_tag :tr do %>
          <th>Published date:</th>
          <td><%= @subject.published_date %></td>
        <% end if @subject.published_date.present? %>
        
        <%= content_tag :tr do %>
          <th>Tags:</th>
          <td><%= @subject.tags.map{|c| content_tag :span, link_to(c.name, subjects_path(q: "tag:#{c.name}"), style: 'color: white;'), class: 'label label-default'}.join(' ').html_safe %></td>
        <% end if @subject.tags.any? %>

        <%= content_tag :tr do %>
          <th>First page:</th>
          <td><%= @subject.first_page %></td>
        <% end if @subject.first_page.present? %>
        <%= content_tag :tr do %>
          <th>Last page:</th>
          <td><%= @subject.last_page %></td>
        <% end if @subject.last_page.present? %>
        <%= content_tag :tr do %>
          <th>Page count:</th>
          <td><%= @subject.page_count %></td>
        <% end if @subject.page_count.present? %>
        
        <%= content_tag :tr do %>
          <th>Abbr:</th>
          <td><%= @subject.abbr %></td>
        <% end if @subject.abbr.present? %>
        <%= content_tag :tr do %>
          <th>Edition:</th>
          <td><%= @subject.edition %></td>
        <% end if @subject.edition.present? %>
        <%= content_tag :tr do %>
          <th>Language:</th>
          <td><%= @subject.language %></td>
        <% end if @subject.language.present? %>
        <%= content_tag :tr do %>
          <th>Publisher:</th>
          <td><%= @subject.publisher.try(:name) %></td>
        <% end if @subject.publisher.present? %>
        <%= content_tag :tr do %>
          <th>Place:</th>
          <td><%= @subject.place.try(:name) %></td>
        <% end if @subject.place.present? %>
      </tbody>
    </table>

    <% if @subject.comments.any? %>
      <%= content_tag :h5, 'Comments' %>
      <% for comment in @subject.comments.order(created_at: :desc) do %>
        <div class="well">
          <p><%= comment.body %></p>
          <p><span class="pull-right"><small><%= comment.created_at.to_formatted_s(:long_ordinal) %></small></span></p>
        </div>
      <% end %>
    <% end %>


    <% if @subject.has_children %>
      <%= content_tag :h5, "Contents #{content_tag :span, @subject.children.count, class: 'badge'}".html_safe if @subject.children.any? %>
      <table class="table table-bordered">
        <tbody>
          <% for child in @subject.children.sort_by { |c| (c.first_page.to_i) } do %>
            <tr>
              <th><%= link_to child.cite, child %>
              <td><%= child.full_entry %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <%= link_to(fa_icon("plus-square-o", text: "add #{@subject.has_children}"), new_subject_path(parent_id: @subject.id), class: 'btn btn-default btn-sm') if current_user %>
    <% end %>
  </div>

  <div class="col-md-4">
    <%= content_tag :div, class: "thumbnail" do %>
      <%= image_tag @subject.g_image_thumbnail, class: 'img-responsive', style: 'width: 100%' if @subject.g_image_thumbnail %>
      <div class="caption">
        <h4><%= @subject.g_volume_id %></h4>
        <p>Description for <%= @subject.g_volume_id %></p>
        <p><%= link_to 'Auf Google Books ansehen', @subject.g_canonical_link %>
        </p>
      </div>
    <% end if @subject.g_volume_id %>
    
      
    <%= content_tag :table, class: 'table table-bordered' do %>
      <tbody>
        <% for id in @subject.identifiers do %>
          <tr>
            <th><%= id.ident_name %></th>
            <td><%= id.ident_value %></td>
          </tr>
        <% end %>
        <tr>
          <th>self</th>
          <td><%= @subject.slug %></td>
        </tr>        
      </tbody>
    <% end %>
    
    <h6>Export cite</h6>
    <%= link_to 'BIBTex', '', class: 'btn btn-default btn-sm disabled' %>
    <%= link_to 'EndNote', '', class: 'btn btn-default btn-sm disabled' %>
    <%= link_to 'RefMan', '', class: 'btn btn-default btn-sm disabled' %>
    <%= link_to 'JSON', api_citation_path(@subject), class: 'btn btn-default btn-sm' %>
  </div>
</div>